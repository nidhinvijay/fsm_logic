<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Indian Options (Paper + Live)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 1400px;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f5f5f5;
      }
      .num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      code {
        background: #f6f8fa;
        padding: 2px 4px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h2>Indian Options (Paper + Live)</h2>

    <p style="font-size: 12px;">
      This page shows per-instrument paper + live state. Zerodha ticks can be
      pushed to <code>POST /zerodha/tick</code> with
      <code>{"token":123,"ltp":12.34}</code>.
    </p>

    <p style="font-size: 12px;">
      Graph: <a href="/optionsgraph.html">/optionsgraph.html</a>
    </p>

    <div style="margin: 10px 0; font-size: 12px;">
      <button id="refreshBtn">Refresh</button>
      <span id="status"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Graph</th>
          <th>TradingView</th>
          <th>Zerodha</th>
          <th>Token</th>
          <th class="num">LTP</th>
          <th>Paper State</th>
          <th>Paper Position</th>
          <th>Paper Triggers/Stops</th>
          <th class="num">Paper Cum</th>
          <th class="num">Paper Real</th>
          <th class="num">Paper Unrl</th>
          <th>Live State</th>
          <th>Live Position</th>
          <th class="num">Live Cum</th>
          <th class="num">Live Real</th>
          <th class="num">Live Unrl</th>
          <th>Live Last Close</th>
          <th>Lock</th>
          <th class="num">Trades</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <h3 style="margin-top: 24px;">Recent Incoming Signals (Options)</h3>
    <p style="font-size: 12px; color: #666;">
      Filtered from <code>/recent-signals</code> where Routed To = OPTIONS.
    </p>
    <table>
      <thead>
        <tr>
          <th>Time (IST)</th>
          <th>Action</th>
          <th>StopPx</th>
          <th>Raw Symbol</th>
          <th>Mapped Symbol</th>
          <th>Note</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody id="signalsRows">
        <tr>
          <td colspan="7">No signals yet</td>
        </tr>
      </tbody>
    </table>

    <script>
      const statusEl = document.getElementById('status');
      const rowsEl = document.getElementById('rows');
      const refreshBtn = document.getElementById('refreshBtn');
      const signalsRowsEl = document.getElementById('signalsRows');
      const rowByTradingview = new Map();

      function fmtNum(value) {
        if (value == null) return '';
        const n = Number(value);
        if (!Number.isFinite(n)) return '';
        return n.toFixed(2);
      }

      function fmtPos(p) {
        if (!p || !p.isOpen) return 'No position';
        const side = p.side ? String(p.side) : 'BUY';
        const entry = p.entryPrice != null ? fmtNum(p.entryPrice) : '';
        return `${side} @ ${entry}`;
      }

      function fmtTriggers(t) {
        if (!t) return '';
        const obj = {
          savedBUYLTP: t.savedBUYLTP,
          buyEntryTrigger: t.buyEntryTrigger,
          buyStop: t.buyStop,
          windowStartTs: t.windowStartTs,
          windowDurationMs: t.windowDurationMs,
          waitSourceState: t.waitSourceState,
        };
        return `<details><summary>view</summary><pre style="margin:6px 0; white-space:pre-wrap;">${JSON.stringify(
          obj,
          null,
          2,
        )}</pre></details>`;
      }

      function fmtLiveLastClose(live) {
        const trades = live && Array.isArray(live.recentTrades) ? live.recentTrades : [];
        const lastClose = [...trades].reverse().find((t) => t && t.action === 'CLOSE');
        if (!lastClose) return '';
        const exit = lastClose.exitPrice != null ? fmtNum(lastClose.exitPrice) : '';
        const pnl = lastClose.tradePnl != null ? fmtNum(lastClose.tradePnl) : '';
        const ts = (lastClose.tsIst || '').replace('T', ' ').slice(0, 16);
        return `${ts} exit=${exit} pnl=${pnl}`;
      }

      function createRowCells() {
        const tr = document.createElement('tr');
        const cells = [];
        for (let i = 0; i < 19; i++) {
          const td = document.createElement('td');
          tr.appendChild(td);
          cells.push(td);
        }

        // numeric alignment columns
        [3, 4, 8, 9, 10, 13, 14, 15, 18].forEach((idx) => {
          cells[idx].className = 'num';
        });

        // graph link
        const a = document.createElement('a');
        a.textContent = 'graph';
        cells[0].appendChild(a);

        return { tr, cells, graphLink: a };
      }

      function getOrCreateRow(tradingview) {
        const existing = rowByTradingview.get(tradingview);
        if (existing) return existing;
        const created = createRowCells();
        rowByTradingview.set(tradingview, created);
        rowsEl.appendChild(created.tr);
        return created;
      }

      async function loadSignals() {
        try {
          const res = await fetch('/recent-signals');
          const data = await res.json();
          const rows = Array.isArray(data.rows) ? data.rows : [];
          const optRows = rows.filter((r) => r && r.routedTo === 'OPTIONS');

          signalsRowsEl.innerHTML = '';
          if (!optRows.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 7;
            td.textContent = 'No signals yet';
            tr.appendChild(td);
            signalsRowsEl.appendChild(tr);
            return;
          }

          optRows.slice(-50).forEach((r) => {
            const tr = document.createElement('tr');
            const cols = [
              (r.tsIst || '').replace('T', ' ').slice(0, 16),
              r.parsedAction || '',
              typeof r.stopPx === 'number' ? r.stopPx.toFixed(2) : '',
              r.rawSymbol || '',
              r.symbol || '',
              (r.note || '').slice(0, 80),
              (r.rawMessage || '').slice(0, 120),
            ];
            cols.forEach((v, idx) => {
              const td = document.createElement('td');
              td.textContent = v;
              if (idx >= 5) td.style.textAlign = 'left';
              tr.appendChild(td);
            });
            signalsRowsEl.appendChild(tr);
          });
        } catch (e) {
          // don't fail the whole page
        }
      }

      async function load() {
        statusEl.textContent = 'Refreshing...';

        try {
          const [instRes, stateRes] = await Promise.all([
            fetch('/options/instruments'),
            fetch('/options/state'),
          ]);
          const instData = await instRes.json();
          const stateData = await stateRes.json();
          const instruments = instData.instruments || [];
          const rows = stateData.rows || [];

          const byTv = new Map(instruments.map((i) => [i.tradingview, i]));
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const dd = String(today.getDate()).padStart(2, '0');
          const todayKey = `${yyyy}-${mm}-${dd}`;

          for (const r of rows) {
            const meta = byTv.get(r.tradingview);
            const tradingview = r.tradingview || '';
            if (!tradingview) continue;

            const row = getOrCreateRow(tradingview);
            const graphHref = `/optionsgraph.html?symbol=${encodeURIComponent(
              tradingview,
            )}&date=${encodeURIComponent(todayKey)}`;

            row.graphLink.href = graphHref;
            row.cells[1].textContent = tradingview;
            row.cells[2].textContent = meta ? meta.zerodha : '';
            row.cells[3].textContent = meta ? String(meta.token ?? '') : '';
            row.cells[4].textContent = fmtNum(r.lastPrice);
            row.cells[5].textContent = r.paper?.state || '';
            row.cells[6].textContent = fmtPos(r.paper?.position);
            row.cells[7].innerHTML = fmtTriggers(r.paper?.triggers);
            row.cells[8].textContent = fmtNum(r.paper?.cumPnl);
            row.cells[9].textContent = fmtNum(r.paper?.realizedCumPnl);
            row.cells[10].textContent = fmtNum(r.paper?.unrealizedPnl);
            row.cells[11].textContent = r.live?.state || '';
            row.cells[12].textContent = fmtPos(r.live?.position);
            row.cells[13].textContent = fmtNum(r.live?.cumPnl);
            row.cells[14].textContent = fmtNum(r.live?.realizedCumPnl);
            row.cells[15].textContent = fmtNum(r.live?.unrealizedPnl);
            row.cells[16].textContent = fmtLiveLastClose(r.live);
            row.cells[17].textContent = r.live?.lockUntilTs
              ? new Date(r.live.lockUntilTs).toISOString()
              : '';
            row.cells[18].textContent =
              r.paper?.tradesCount != null ? String(r.paper.tradesCount) : '';
          }

          const now = new Date();
          const hh = String(now.getHours()).padStart(2, '0');
          const min = String(now.getMinutes()).padStart(2, '0');
          const ss = String(now.getSeconds()).padStart(2, '0');
          statusEl.textContent = `Loaded ${rows.length} instruments @ ${hh}:${min}:${ss}.`;
        } catch (e) {
          statusEl.textContent = `Error: ${String(e)}`;
        }

        loadSignals();
      }

      refreshBtn.addEventListener('click', load);
      load();
      setInterval(load, 5000);
    </script>
  </body>
</html>
