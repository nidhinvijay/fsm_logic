<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BTCUSD PnL Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .row {
        margin-bottom: 16px;
      }
      #chart-container {
        width: 100%;
        max-width: 1000px;
        height: 500px;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 6px;
        text-align: right;
      }
      th {
        background: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <h2>BTCUSD PnL History (Paper + Live)</h2>

    <div class="row">
      <label for="dateInput">Date (YYYY-MM-DD): </label>
      <input id="dateInput" type="date" />
      <button id="loadBtn">Load</button>
      <span id="status" style="margin-left: 10px; font-size: 12px;"></span>
    </div>

    <h3>Long Side (BUY)</h3>
    <div id="chart-container">
      <canvas id="longChart"></canvas>
    </div>

    <h3>Short Side (SELL)</h3>
    <div id="chart-container">
      <canvas id="shortChart"></canvas>
    </div>

    <h3>Trades (rows where a trade was closed)</h3>
    <table id="tradesTable">
      <thead>
        <tr>
          <th>Time (IST)</th>
          <th>Side</th>
          <th>Entry</th>
          <th>Exit</th>
          <th>Trade PnL</th>
          <th>Live Long Cum</th>
          <th>Live Short Cum</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const dateInput = document.getElementById('dateInput');
      const loadBtn = document.getElementById('loadBtn');
      const statusEl = document.getElementById('status');
      const tradesBody = document.querySelector('#tradesTable tbody');

      // default to today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      let longChart;
      let shortChart;

      async function loadData() {
        const date = dateInput.value;
        if (!date) {
          statusEl.textContent = 'Please pick a date.';
          return;
        }

        statusEl.textContent = 'Loading...';

        try {
          const res = await fetch(`/pnl-history?date=${encodeURIComponent(date)}`);
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            statusEl.textContent = `Error: ${res.status} ${err.error || ''}`;
            return;
          }

          const data = await res.json();
          let rows = data.rows || [];

          // Filter rows to custom "trading day" window:
          // from 05:30 IST of selected date to 05:30 IST of next day.
          if (rows.length) {
            const [yearStr, monthStr, dayStr] = date.split('-');
            const year = parseInt(yearStr, 10);
            const month = parseInt(monthStr, 10) - 1;
            const day = parseInt(dayStr, 10);

            const start = new Date(year, month, day, 5, 30, 0);
            const end = new Date(start.getTime() + 24 * 60 * 60 * 1000);

            const parseIst = (timeIst) => {
              // timeIst format: "YYYY-MM-DD HH:MM"
              const [dPart, tPart] = timeIst.split(' ');
              const [yStr, mStr, dStr] = dPart.split('-');
              const [hhStr, mmStr] = (tPart || '00:00').split(':');
              const yy = parseInt(yStr, 10);
              const mm = parseInt(mStr, 10) - 1;
              const dd = parseInt(dStr, 10);
              const hh = parseInt(hhStr, 10);
              const mi = parseInt(mmStr, 10);
              return new Date(yy, mm, dd, hh, mi, 0);
            };

            rows = rows.filter((r) => {
              const dt = parseIst(r.timeIst);
              return dt >= start && dt < end;
            });
          }

          if (!rows.length) {
            statusEl.textContent = 'No data for this date.';
          } else {
            statusEl.textContent = `Loaded ${rows.length} rows.`;
          }

          const labels = rows.map((r) => r.timeIst);
          const paperLong = rows.map((r) => r.paperLongCumPnl);
          const paperShort = rows.map((r) => r.paperShortCumPnl);
          const liveLong = rows.map((r) => r.liveLongCumPnl);
          const liveShort = rows.map((r) => r.liveShortCumPnl);

          const longCtx = document.getElementById('longChart').getContext('2d');
          const shortCtx = document
            .getElementById('shortChart')
            .getContext('2d');

          if (longChart) longChart.destroy();
          if (shortChart) shortChart.destroy();

          longChart = new Chart(longCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Paper LONG cum',
                  data: paperLong,
                  borderColor: 'blue',
                  fill: false,
                },
                {
                  label: 'Paper SHORT cum',
                  data: [], // not used on long chart
                  borderColor: 'green',
                  fill: false,
                  hidden: true,
                },
                {
                  label: 'Live LONG cum',
                  data: liveLong,
                  borderColor: 'orange',
                  borderDash: [5, 5],
                  fill: false,
                },
              ],
            },
            options: {
              responsive: true,
              interaction: { mode: 'index', intersect: false },
              stacked: false,
              scales: {
                x: {
                  ticks: { maxRotation: 90, minRotation: 45 },
                },
                y: {
                  title: { display: true, text: 'Cum PnL (LONG)' },
                },
              },
              plugins: {
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'x',
                  },
                  pan: {
                    enabled: true,
                    mode: 'x',
                  },
                },
              },
            },
          });

          shortChart = new Chart(shortCtx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Paper SHORT cum',
                  data: paperShort,
                  borderColor: 'green',
                  fill: false,
                },
                {
                  label: 'Paper LONG cum',
                  data: [], // not used on short chart
                  borderColor: 'blue',
                  fill: false,
                  hidden: true,
                },
                {
                  label: 'Live SHORT cum',
                  data: liveShort,
                  borderColor: 'red',
                  borderDash: [5, 5],
                  fill: false,
                },
              ],
            },
            options: {
              responsive: true,
              interaction: { mode: 'index', intersect: false },
              stacked: false,
              scales: {
                x: {
                  ticks: { maxRotation: 90, minRotation: 45 },
                },
                y: {
                  title: { display: true, text: 'Cum PnL (SHORT)' },
                },
              },
              plugins: {
                zoom: {
                  zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'x',
                  },
                  pan: {
                    enabled: true,
                    mode: 'x',
                  },
                },
              },
            },
          });

          // Fill trades table
          tradesBody.innerHTML = '';
          rows
            .filter((r) => r.tradeSide)
            .forEach((r) => {
              const tr = document.createElement('tr');
              const cells = [
                r.timeIst,
                r.tradeSide,
                r.tradeEntry != null ? r.tradeEntry.toFixed(2) : '',
                r.tradeExit != null ? r.tradeExit.toFixed(2) : '',
                r.tradePnl != null ? r.tradePnl.toFixed(2) : '',
                r.liveLongCumPnl.toFixed(2),
                r.liveShortCumPnl.toFixed(2),
              ];
              cells.forEach((val) => {
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);
              });
              tradesBody.appendChild(tr);
            });
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Error fetching data.';
        }
      }

      loadBtn.addEventListener('click', loadData);
      // auto-load on open
      loadData();
    </script>
  </body>
  </html>
